<div class="mb-6 w-[85%] mx-auto max-w-6xl">
  <!-- 股票標題與收藏 -->
  <div class="flex mb-4 justify-between mt-6 md-4">
    <h2 class="text-3xl font-bold text-primary cursor-pointer flex items-center gap-2" ng-click="star()">
      <span ng-bind="stock.name"></span>

      <span ng-if="!stock.stared" class="text-base-300 hover:text-error transition-colors"><svg fill="currentColor"
          class="icon-heart size-[1.3em] ml-3 mr-1 stroke-base-content stroke-2">
          <use xlink:href="css/symbol-defs.svg#icon-heart"></use>
        </svg></span>
      <span ng-if="stock.stared" class="text-error"><svg fill="currentColor"
          class="icon-heart size-[1.3em] ml-3 mr-1 text-rich-red">
          <use xlink:href="css/symbol-defs.svg#icon-heart"></use>
        </svg></span>
    </h2>
    <div class="flex gap-2">
      <button class="btn btn-primary btn-sm" ng-click="invest.edit({ act: '買入' })">
        <svg fill="currentColor" class="icon-add-cart size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-add-cart"></use>
        </svg>
        買入
      </button>
      <button class="btn btn-secondary btn-sm" ng-click="dividend.edit({})">
        <svg fill="currentColor" class="icon-salary size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-salary"></use>
        </svg>
        股利
      </button>
    </div>
  </div>

  <!-- 即時價格資訊 -->
  <div ng-if="stock.realtime" class="flex gap-4 justify-center flex-wrap">
    <!-- 價格主要資訊 -->
    <div class="">
      <div class="flex items-center justify-between mb-3 text-lg">
        <div class="badge badge-outline" ng-bind="stock.realtime.date | date:'MM/dd'"></div>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost btn-xs" ng-click="sync()">
            <svg fill="currentColor" class="icon-spinner9 size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-spinner9"></use>
            </svg>
          </button>
          <a class="btn btn-ghost btn-xs" title="本益比河流圖"
            ng-href="https://www.wantgoo.com/stock/{{stock.code}}/enterprise-value/price-to-earning-river"
            target="_wantgoo">
            <svg fill="currentColor" class="icon-market size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-market"></use>
            </svg>
          </a>
          <a class="btn btn-ghost btn-xs" title="歷年股利"
            ng-href="https://www.wantgoo.com/stock/{{stock.code}}/dividend-policy/ex-dividend" target="_wantgoo">
            <svg fill="currentColor" class="icon-finance size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-finance"></use>
            </svg>
          </a>
        </div>
      </div>

      <div class="text-center">
        <div class="text-4xl font-bold mb-2"
          ng-class="{'text-rich-red': (stock.realtime.diff > 0), 'text-rich-green': (stock.realtime.diff < 0), 'text-base-content': (stock.realtime.diff == 0)}">
          <span ng-bind="stock.realtime.close.scale(2)"></span>
        </div>
        <div class="flex items-center justify-center gap-2 text-lg font-semibold"
          ng-class="{'text-rich-red': (stock.realtime.diff > 0), 'text-rich-green': (stock.realtime.diff < 0)}">
          <span ng-if="stock.realtime.diff > 0">▲</span>
          <span ng-if="stock.realtime.diff < 0">▼</span>
          <span ng-bind="stock.realtime.diff.scale(2)"></span>
          <span>（<span ng-bind="(stock.realtime.diffRate * 100).scale(2)"></span>%）</span>
        </div>
      </div>
    </div>

    <!-- 開高低量資訊 -->
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">開</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.open.scale(2)"></div>
      </div>
      <div class="stat ">
        <div class="stat-title">高</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.high.scale(2)"></div>
      </div>
      <div class="stat">
        <div class="stat-title">低</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.low.scale(2)"></div>
      </div>
      <div class="stat">
        <div class="stat-title ">量</div>
        <div class="stat-value" ng-bind="stock.realtime.volume"></div>
      </div>
    </div>

    <!-- 股利資訊 -->
    <div ng-if="stock.dividend" class="badge badge-ghost w-full">
      <svg fill="currentColor" class="icon-salary size-[1.5em]">
        <use xlink:href="css/symbol-defs.svg#icon-salary"></use>
      </svg>
      <div>
        <div class="font-bold">股利資訊</div>
        <div class="text-sm">
          <span ng-bind="stock.dividend['除息日']"></span>：
          ＄<span ng-bind="stock.dividend['股利']"></span>
          （<span ng-bind="stock.dividend['年殖利率']"></span>％）➡︎
          <span ng-bind="stock.dividend['發放日']"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div ng-if="stock.trade.invest" class="mb-6 w-[85%] mx-auto max-w-6xl"
  ng-class="{'border-2 border-warning': stock.trade.invest.rsiHot}">
  <h3 class="text-2xl font-bold text-primary mb-4 flex items-center gap-2">
    <svg fill="currentColor" class="icon-investment size-[1.5em]">
      <use xlink:href="css/symbol-defs.svg#icon-investment"></use>
    </svg>
    投資紀錄
    <span ng-if="stock.trade.invest.rsiHot" class="badge badge-warning">過熱</span>
  </h3>

  <!-- 投資交易列表 -->
  <div ng-class="{'bg-warning/10 border border-warning rounded-xl p-2': !log.id}" ng-if="log.act"
    ng-repeat="log in stock.trade.invest.logs"
    class="grid grid-cols-3 gap-4 p-4 border-b border-base-200 last:border-b-0">

    <!-- 交易基本資訊 -->
    <div class="bg-success rounded-xl p-4 text-center">
      <div class="text-xs text-success-content opacity-70" ng-bind="(log.date || log.day.date) | date:'MM/dd'"></div>
      <div class="text-2xl font-bold text-success-content" ng-bind="(log.price || log.day.close).scale(2)"></div>
      <div class="text-sm text-success-content font-semibold" ng-bind="log.act"></div>
    </div>

    <!-- 持倉詳情 -->
    <div class="bg-neutral rounded-xl p-4">
      <div class="grid grid-cols-2 gap-2 text-neutral-content">
        <div class="text-center">
          <div class="text-xs opacity-70">交易</div>
          <div class="text-lg font-bold" ng-bind="log.amount"></div>
          <div class="text-xs">股</div>
        </div>
        <div class="text-center">
          <div class="text-xs opacity-70">持倉</div>
          <div class="text-lg font-bold" ng-bind="log.totalInvested"></div>
          <div class="text-xs">股</div>
        </div>
        <div class="text-center col-span-2">
          <div class="text-xs opacity-70">平均成本</div>
          <div class="text-lg font-bold" ng-bind="log.avgCost"></div>
        </div>
      </div>
    </div>

    <!-- 損益與控制 -->
    <div class="bg-info rounded-xl p-4 text-center">
      <div ng-if="log.invested > 0" class="text-xs text-info-content opacity-70">目前損益</div>
      <div ng-if="log.invested == 0" class="text-xs text-info-content opacity-70">實現損益</div>
      <div class="text-2xl font-bold text-info-content flex items-center justify-center gap-1">
        <svg fill="currentColor" ng-if="stock.trade.invest.netProfit < 0" class="icon-crying size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-crying"></use>
        </svg>
        <svg fill="currentColor" ng-if="stock.trade.invest.netProfit > 0" class="icon-grin size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-grin"></use>
        </svg>
        <span ng-bind="stock.trade.invest.netProfit"></span>
      </div>
      <div class="text-sm text-info-content font-semibold">（<span ng-bind="stock.trade.invest.profitRate"></span>）</div>
    </div>

    <!-- 停損停利資訊 -->
    <div class="col-span-3 bg-secondary rounded-xl p-4">
      <div class="grid grid-cols-3 gap-4 text-secondary-content text-center">
        <div>
          <div class="text-xs opacity-70">停損價</div>
          <div class="text-lg font-bold text-rich-green" ng-bind="stock.trade.invest.stopLossPrice.scale(2)"></div>
        </div>
        <div>
          <div class="text-xs opacity-70">停利價</div>
          <div class="text-lg font-bold text-rich-red" ng-bind="stock.trade.invest.stopProfitPrice.scale(2)"></div>
        </div>
        <div>
          <div class="text-xs opacity-70">稅費</div>
          <div class="text-lg font-bold" ng-bind="stock.trade.invest.tax.scale(2)"></div>
        </div>
      </div>
    </div>

    <!-- 操作按鈕 -->
    <div class="col-span-3 flex justify-end gap-2">
      <button ng-if="log.id" class="btn btn-primary btn-sm" ng-click="invest.edit(log)">
        <svg fill="currentColor" class="icon-edit size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-edit"></use>
        </svg>
        編輯
      </button>
      <button ng-if="log.act == '買入'" class="btn btn-error btn-sm" ng-click="invest.edit({ act: '賣出' })">
        <svg fill="currentColor" class="icon-arrow-down size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-arrow-down"></use>
        </svg>
        賣出
      </button>
    </div>
  </div>
</div>

<div ng-if="notes.length" class="bg-base-100 rounded-2xl p-6 shadow-lg mb-6">
  <h3 class="text-2xl font-bold text-primary mb-4 flex items-center gap-2">
    <svg fill="currentColor" class="icon-addnote size-[1.5em]">
      <use xlink:href="css/symbol-defs.svg#icon-addnote"></use>
    </svg>
    相關筆記
  </h3>
  <div class="space-y-2">
    <div class="list-row cursor-pointer hover:bg-base-200 rounded-xl p-3" ng-repeat="note in notes"
      ng-click="edit(note)">
      <span ng-bind="note.date | date:'MM/dd'" class="font-date text-xl text-accent mr-4"></span>
      <span ng-bind="note.title" class="text-base-content"></span>
    </div>
  </div>
</div>
<div ng-if="dividends.length" class="notes_block">
  <div style="cursor:pointer" ng-repeat="d in dividends" ng-click="dividend.edit(d)">
    <span class="date--note" ng-bind="d.date | date:'MM/dd'"></span>
    每股 <span ng-bind="d.price"></span> 元
    × <span ng-bind="d.amount"></span> 股
    ＝ 獲利 <span ng-bind="d.payment | number"></span> 元
  </div>
</div>

<div ng-if="stock.done.length" class="stock_result">
  <div ng-repeat="trade in stock.done">
    <span class="date--result" ng-bind="trade.entryDate | date:'MM/dd'"></span>
    <span class="price--result" ng-bind="trade.entryPrice"></span> 買入
    <span class="date--result" ng-bind="trade.exitDate | date:'MM/dd'"></span>
    <span class="price--result" ng-bind="trade.exitPrice"></span> 賣出
    稅金 <span class="price--result" ng-bind="trade.tax | number"></span>
    已實現損益 <span class="price--result" ng-bind="trade.netProfit | number"></span>
    （<span class="pct--result" ng-bind="trade.netProfitRate | pct"></span>）
  </div>
</div>

<div class="stock_trades">
  <ng-container ng-repeat="test in tests">
    <input type="radio" name="tabset" id="tab{{$index}}" ng-checked="$index === 0">
    <label for="tab{{$index}}" id="label{{$index}}">
      <span class="ma--label" ng-bind="test.ma"></span>
      <span class="date--label"><span ng-bind="test.startDate | dt"></span> ~
        <span ng-bind="test.endDate | dt"></span></span>
      <div class="stock_trades-price">
        <span class="price--label" ng-bind="test.profit"></span>
        <span class="pct--label rate" ng-bind="test.profitRate | pct" ng-click="allBand(test)"></span>
      </div>
    </label>
    <div class="stock_trades-info" id="info{{$index}}">
      <div>
        <a href="https://t.ly/TgoWR" target="_faq">盈虧比</a> <span ng-bind="test.pnl"></span>
        期望值 <span class="price--label" ng-bind="test.expectation"></span>
        <span ng-if="test.expectation > 1">👍</span>
      </div>
      <div>
        二日有效率 <span class="pct--breakoutRate" ng-bind="test.breakoutRate | pct"></span>
        總勝率 <span class="pct--winRate" ng-bind="test.winRate | pct"></span>
      </div>

      <div>
        返場 <span ng-bind="test.reentry"></span> 次
        成功 <span ng-bind="test.reentryWins"></span> 次
        勝率 <span class="pct--reentryWinRate" ng-bind="test.reentryWinRate | pct"></span><br />
        返場損益 <span class="price--label" ng-bind="test.reentryProfit"></span>
        <span class="pct--reentryProfit" ng-bind="(test.reentryProfit / test.profit) | pct"></span>
      </div>
      <!--<div>最大回撤 <span ng-bind="test.maxDrawdown"></span></div>-->
    </div>
    <div id="trade{{$index}}">
      <div class="stock_trades_row" ng-repeat="trade in test.trades" style="cursor:pointer" ng-click="jump(trade)">
        <div class="date--dates">
          <div>🗓️ <span ng-bind="trade.entryDate | dt"></span> ~
            <span ng-bind="trade.exitDate | dt"></span>
            <span ng-if="trade.duration" ng-bind="trade.duration"></span>
          </div>
          <span class="rt-badge" ng-if="trade.breakout">二日法則</span>
          <span class="rt-badge" ng-if="trade.reentry">重新入場</span>
        </div>
        <div>
          <div class="info-banner">💰📈 <span class="price--inout" ng-bind="trade.entryPrice.scale(2)"></span></div>
          <div class="info-banner" ng-if="trade.exitPrice">🏃📉 <span class="price--inout"
              ng-bind="trade.exitPrice.scale(2)"></span></div>
        </div>
        <div class="profit" ng-if="trade.duration">
          <div>🧧 <span class="price--profit" ng-bind="trade.profit"></span></div>
          <span class="pct--profit" ng-bind="trade.profitRate | pct"></span>
        </div>

        <div ng-if="trade.invest" class="profit">
          <div ng-if="trade.invest.profit != 0" class="price--profit">🤑 <span ng-bind="trade.invest.profit"></span>
          </div>
          <span ng-if="trade.invest.profit != 0" class="pct--profit" ng-bind="trade.invest.profitRate | pct"></span>
        </div>

        <div class="reason">
          <span ng-bind="trade.entryReason"></span>
          <span ng-bind="trade.exitReason"></span>
          <span class="rt-badge" ng-if="trade.exitReason.includes('過熱')">過熱</span>
        </div>
        <div ng-if="trade.invest" class="investstock" ng-class="{'rich-stock-trade-rsi-hot': trade.invest.rsiHot}">
          <div ng-if="log.act" ng-repeat="log in trade.invest.logs">
            <span class="date" ng-bind="log.day.date.toLocaleDateString()"></span>
            <span class="price" ng-bind="log.day.close.scale(2)"></span>
            <span ng-bind="log.act"></span>：<span class="percent" ng-bind="log.amount"></span>
            持倉：<span class="percent" ng-bind="log.invested"></span>
            成本：<span class="price" ng-bind="log.avgCost"></span>
            停損價：<span class="price" ng-bind="(log.stopLossPrice || 0).scale(2)"></span>
            <span class="result" ng-if="log.profit != 0">
              <span ng-if="log.invested > 0">當前</span>損益
              <span class="price" ng-bind="log.profit"></span>（<span class="percent" ng-bind="log.profitRate"></span>）
            </span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<div id="invest-form" style="display: none">
  <br />
  <div>
    <span ng-bind="invest.log.act"></span>
    <input type="date" ng-model="invest.log.date">
    <input type="number" ng-model="invest.log.price"> 元
    <input type="number" ng-model="invest.log.amount"> 股
  </div>
  <br />
  <div>
    <textarea rows="4" cols="50" ng-model="note.log.note"></textarea>
  </div>
  <div>
    <p>
      <button ng-click="invest.save()">確認</button>
      <button ng-if="invest.log.id" ng-click="invest.destroy()">刪除</button>
    </p>
  </div>
</div>

<div id="dividend-form" style="display: none">
  <br />
  <div>
    <span>收款紀錄</span>
    <input type="date" ng-model="dividend.trade.date">
    <input type="number" ng-model="dividend.trade.price"> 元
    <input type="number" ng-model="dividend.trade.amount"> 股
  </div>
  <div>
    <p>
      <button ng-click="dividend.save()">確認</button>
      <button ng-if="dividend.trade.id" ng-click="dividend.destroy()">刪除</button>
    </p>
  </div>
</div>

<div id="stock-check-list" style="display: none">
  <div class="checklist">
    <div class="caption">
      <span ng-bind="blankList.title"></span>
    </div>
    <div class="header-row">
      <div class="header-cell">多方檢查</div>
      <div class="header-cell">空方檢查</div>
    </div>
    <div class="content-row">
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.long.required">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.short.required">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="content-row">
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.long.optional">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.short.optional">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="rich-stock-chart">
  <label ng-repeat="axis in chartAxis.all">
    <input type="checkbox" ng-model="axis.visible" ng-change="chartAxis.toggle(axis)">
    <a target="_blank" ng-href="{{ axis.url }}"><span ng-bind="axis.id"></span></a>
  </label>
</div>
<div id="stock-chart" style="height: 800px; min-width: 800px"></div>