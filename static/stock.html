<div class="mb-6 w-[85%] mx-auto max-w-6xl">
  <!-- 股票標題與收藏 -->
  <div class="flex mb-4 justify-between mt-6 md-4">
    <h2 class="text-3xl font-bold text-primary cursor-pointer flex items-center gap-2" ng-click="star()">
      <span ng-bind="stock.name"></span>
      <span ng-if="!stock.stared" class="text-base-300 hover:text-error transition-colors"><svg fill="currentColor"
          class="icon-heart size-[1.3em] ml-3 mr-1 stroke-base-content stroke-2">
          <use xlink:href="css/symbol-defs.svg#icon-heart"></use>
        </svg></span>
      <span ng-if="stock.stared" class="text-error"><svg fill="currentColor"
          class="icon-heart size-[1.3em] ml-3 mr-1 text-rich-red">
          <use xlink:href="css/symbol-defs.svg#icon-heart"></use>
        </svg></span>
    </h2>
    <div class="flex gap-2">
      <button class="btn btn-primary btn-sm" ng-click="invest.edit({ act: '買入' })">
        <svg fill="currentColor" class="icon-add-cart size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-add-cart"></use>
        </svg>
        買入
      </button>
      <button class="btn btn-secondary btn-sm" ng-click="dividend.edit({})">
        <svg fill="currentColor" class="icon-salary size-[1em]">
          <use xlink:href="css/symbol-defs.svg#icon-salary"></use>
        </svg>
        股利
      </button>
    </div>
  </div>
  <!-- 即時價格資訊 -->
  <div ng-if="stock.realtime" class="flex gap-4 justify-center flex-wrap">
    <!-- 價格主要資訊 -->
    <div class="">
      <div class="flex items-center justify-between mb-3 text-lg">
        <div class="badge badge-outline" ng-bind="stock.realtime.date | date:'MM/dd'"></div>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost btn-xs" ng-click="sync()">
            <svg fill="currentColor" class="icon-spinner9 size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-spinner9"></use>
            </svg>
          </button>
          <a class="btn btn-ghost btn-xs" title="本益比河流圖"
            ng-href="https://www.wantgoo.com/stock/{{stock.code}}/enterprise-value/price-to-earning-river"
            target="_wantgoo">
            <svg fill="currentColor" class="icon-market size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-market"></use>
            </svg>
          </a>
          <a class="btn btn-ghost btn-xs" title="歷年股利"
            ng-href="https://www.wantgoo.com/stock/{{stock.code}}/dividend-policy/ex-dividend" target="_wantgoo">
            <svg fill="currentColor" class="icon-finance size-[1em]">
              <use xlink:href="css/symbol-defs.svg#icon-finance"></use>
            </svg>
          </a>
        </div>
      </div>
      <div class="text-center">
        <div class="text-4xl font-bold mb-2"
          ng-class="{'text-rich-red': (stock.realtime.diff > 0), 'text-rich-green': (stock.realtime.diff < 0), 'text-base-content': (stock.realtime.diff == 0)}">
          <span class="font-price" ng-bind="stock.realtime.close.scale(2)"></span>
        </div>
        <div class="flex items-center justify-center gap-2 text-lg font-semibold"
          ng-class="{'text-rich-red': (stock.realtime.diff > 0), 'text-rich-green': (stock.realtime.diff < 0)}">
          <span ng-if="stock.realtime.diff > 0">▲</span>
          <span ng-if="stock.realtime.diff < 0">▼</span>
          <span ng-bind="stock.realtime.diff.scale(2)"></span>
          <span>（<span ng-bind="(stock.realtime.diffRate * 100).scale(2)"></span>%）</span>
        </div>
      </div>
    </div>
    <!-- 開高低量資訊 -->
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-title">開</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.open.scale(2)"></div>
      </div>
      <div class="stat ">
        <div class="stat-title">高</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.high.scale(2)"></div>
      </div>
      <div class="stat">
        <div class="stat-title">低</div>
        <div class="stat-value font-price" ng-bind="stock.realtime.low.scale(2)"></div>
      </div>
      <div class="stat">
        <div class="stat-title ">量</div>
        <div class="stat-value" ng-bind="stock.realtime.volume"></div>
      </div>
    </div>

    <!-- 股利資訊 -->
    <div ng-if="stock.dividend" class="badge badge-ghost w-full">
      <svg fill="currentColor" class="icon-salary size-[1.5em]">
        <use xlink:href="css/symbol-defs.svg#icon-salary"></use>
      </svg>
      <div>
        <div class="font-bold">股利資訊</div>
        <div class="text-sm">
          <span ng-bind="stock.dividend['除息日']"></span>：
          ＄<span ng-bind="stock.dividend['股利']"></span>
          （<span ng-bind="stock.dividend['年殖利率']"></span>％）➡︎
          <span ng-bind="stock.dividend['發放日']"></span>
        </div>
      </div>
    </div>
  </div>
</div>
<div ng-if="stock.trade.invest" class="mb-6 w-[85%] mx-auto max-w-6xl"
  ng-class="{'border-2 border-warning': stock.trade.invest.rsiHot}">
  <h3 class="text-2xl font-bold text-primary mb-4 flex items-center gap-2">
    投資紀錄
    <span ng-if="stock.trade.invest.rsiHot" class="badge badge-warning">過熱</span>
  </h3>
  <!-- 投資交易列表 -->
  <div ng-class="{'bg-warning/10 border border-warning rounded-xl p-2': !log.id}" ng-if="log.act"
    ng-repeat="log in stock.trade.invest.logs" class="stats shadow bg-white w-full">
    <!-- 交易基本資訊 -->
    <div class="stat">
      <div class="stat-figure text-secondary">
        <svg fill="currentColor" class="icon-add-cart h-8 w-8">
          <use xlink:href="css/symbol-defs.svg#icon-add-cart"></use>
        </svg>
      </div>
      <div class="stat-title">
        <span ng-bind="(log.date || log.day.date) | date:'MM/dd'"></span>
        <span class="badge badge-ghost ml-6" ng-bind="log.act"></span>
      </div>
      <div class="stat-value font-price text-4xl" ng-bind="(log.price || log.day.close).scale(2)"></div>
      <div class="stat-desc"></div>
      <!-- 操作按鈕 -->
      <div class="stat-actions">
        <button ng-if="log.id" class="btn btn-xs btn-success" ng-click="invest.edit(log)">
          <svg fill="currentColor" class="icon-pencil size-[1em]">
            <use xlink:href="css/symbol-defs.svg#icon-pencil"></use>
          </svg>
          編輯
        </button>
        <button ng-if="log.act == '買入'" class="btn btn-xs btn-success" ng-click="invest.edit({ act: '賣出' })">
          <svg fill="currentColor" class="icon-arrow-down size-[1em]">
            <use xlink:href="css/symbol-defs.svg#icon-arrow-down"></use>
          </svg>
          賣出
        </button>
      </div>
    </div>
    <!-- 損益與控制 -->
    <div class="stat">
      <div class="stat-figure"
        ng-class="{'text-rich-green': stock.trade.invest.netProfit < 0, 'text-rich-red': stock.trade.invest.netProfit > 0}">
        <svg fill="currentColor" ng-if="stock.trade.invest.netProfit < 0" class="icon-crying h-8 w-8">
          <use xlink:href="css/symbol-defs.svg#icon-crying"></use>
        </svg>
        <svg fill="currentColor" ng-if="stock.trade.invest.netProfit > 0" class="icon-grin h-8 w-8">
          <use xlink:href="css/symbol-defs.svg#icon-grin"></use>
        </svg>
      </div>
      <div class="stat-title">
        <span ng-if="log.invested > 0">目前損益</span>
        <span ng-if="log.invested == 0">實現損益</span>
      </div>
      <div class="stat-value font-price text-4xl" ng-bind="stock.trade.invest.netProfit"></div>
      <div class="stat-desc font-pct" ng-bind="(stock.trade.invest.profitRate * 100).scale(2)"></div>
    </div>
    <!-- 停損停利資訊 -->
    <div class="stat">
      <div class="stat-title">停損價</div>
      <div class="stat-value font-price text-lg text-rich-green" ng-bind="stock.trade.invest.stopLossPrice.scale(2)">
      </div>
      <div class="stat-title">停利價</div>
      <div class="stat-value font-price text-lg text-rich-red" ng-bind="stock.trade.invest.stopProfitPrice.scale(2)">
      </div>
      <div class="stat-title">稅費</div>
      <div class="stat-value font-price text-lg text-rich-green" ng-bind="stock.trade.invest.tax.scale(2)"></div>
    </div>
    <!-- 持倉詳情 -->
    <div class="stat">
      <div class="stat-title">交易</div>
      <div class="stat-value text-lg after:content-['股']" ng-bind="log.amount"></div>
      <div class="stat-title">持倉</div>
      <div class="stat-value text-lg after:content-['股']" ng-bind="log.totalInvested"></div>
      <div class="stat-title">平均成本</div>
      <div class="stat-value font-price text-lg" ng-bind="log.avgCost"></div>
    </div>
  </div>
</div>

<div class="mb-4 w-[85%] mx-auto max-w-6xl flex justify-between">
  <h3 class="text-2xl font-bold text-primary">
    相關筆記
  </h3>
  <button class="btn btn-primary" ng-click="note.edit()"><svg fill="currentColor" class="icon-addnote size-[1.5em]">
      <use xlink:href="css/symbol-defs.svg#icon-addnote"></use>
    </svg></button>
</div>

<div class="list w-[85%] mx-auto max-w-6xl">
  <ng-container ng-if="notes.length">
    <div class="list-row cursor-pointer hover:bg-base-100" ng-repeat="note in notes" ng-click="edit(note)">
      <span ng-bind="note.date | date:'MM/dd'" class="font-date text-xl text-accent mr-4"></span>
      <span ng-bind="note.title" class="text-base-content"></span>
    </div>
  </ng-container>
  <ng-container ng-if="dividends.length">
    <div ng-repeat="d in dividends" ng-click="dividend.edit(d)" class="list-row cursor-pointer hover:bg-base-100">
      <span class="font-date text-xl text-info mr-4" ng-bind="d.date | date:'MM/dd'"></span>
      <span>
        每股 <span ng-bind="d.price"></span> 元
        × <span ng-bind="d.amount"></span> 股
        ＝ 獲利 <span ng-bind="d.payment | number"></span> 元
      </span>
    </div>
  </ng-container>
  <!-- 大師操作紀錄 -->
  <ng-container ng-if="stock.shadow.length">
    <div class="list-row cursor-pointer hover:bg-base-100 bg-rich-master/30" ng-repeat="trade in stock.shadow">
      <span class="font-date text-xl text-info mr-4" ng-bind="trade.entryDate | date:'MM/dd'"></span>
      <div class="list-col-grow">
        👽 <span class="font-price text-2xl" ng-bind="trade.netProfit | number"></span>
        （<span class="font-price" ng-bind="trade.netProfitRate | pct"></span>）<br />
        <span class="font-price" ng-bind="trade.entryPrice"></span>
        <span ng-click="invest.edit(trade.logs[0])">買入</span>
        <span ng-bind="trade.logs[0].amount"></span> 股
        <span ng-if="trade.exitDate">
          ／<span class="font-date" ng-bind="trade.exitDate | date:'MM/dd'"></span>
          <span class="font-price" ng-bind="trade.exitPrice"></span>
          <span ng-click="invest.edit(trade.logs[1])">賣出</span>
          <span ng-bind="trade.logs[1].amount"></span> 股／
        </span>
        稅費 <span class="font-price" ng-bind="trade.tax | number"></span>
        <span ng-if="!trade.exitDate" ng-click="invest.edit({ act: '賣出', shadow: true })">賣出</span>
      </div>
    </div>
  </ng-container>
  <ng-container ng-if="stock.done.length">
    <div class="list-row cursor-pointer hover:bg-base-100 bg-secondary/10" ng-repeat="trade in stock.done">
      <span class="font-date text-xl text-info mr-4" ng-bind="trade.entryDate | date:'MM/dd'"></span>
      <div class="list-col-grow">
        <span class="font-price text-2xl" ng-bind="trade.netProfit | number"></span>
        （<span class="font-price" ng-bind="trade.netProfitRate | pct"></span>）<br />
        <span class="font-price" ng-bind="trade.entryPrice"></span>
        <span ng-click="invest.edit(trade.logs[0])">買入</span>
        <span ng-bind="trade.logs[0].amount"></span> 股
        <span ng-if="trade.exitDate">
          ／<span class="font-date" ng-bind="trade.exitDate | date:'MM/dd'"></span>
          <span class="font-price" ng-bind="trade.exitPrice"></span>
          <span ng-click="invest.edit(trade.logs[1])">賣出</span>
          <span ng-bind="trade.logs[1].amount"></span> 股／
        </span>
        稅費 <span class="font-price" ng-bind="trade.tax | number"></span>
      </div>
    </div>
  </ng-container>
</div>

<div class="stock_trades w-[85%] mx-auto max-w-6xl mt-6">
  <ng-container ng-repeat="test in tests">
    <input type="radio" name="tabset" id="tab{{$index}}" ng-checked="$index === 0">
    <label for="tab{{$index}}" id="label{{$index}}" class="text-center">
      <span class="text-4xl text-primary before:content-['MA'] before:text-sm" ng-bind="test.ma"></span>
      <span class="font-date text-xxs bg-primary/50"><span ng-bind="test.startDate | dt"></span> ~
        <span ng-bind="test.endDate | dt"></span></span>
      <div class="stock_trades-price">
        <span class="font-price text-sm" ng-bind="test.profit"></span>
        <span class="font-pct" ng-bind="test.profitRate | pct" ng-click="allBand(test)"></span>
      </div>
    </label>
    <div class="border-l-2 border-primary border-r-2 bg-primary grid grid-cols-3 gap-4 p-4 text-center"
      id="info{{$index}}">
      <div>
        <a href="https://t.ly/TgoWR" target="_faq">盈虧比</a> <span class="text-2xl" ng-bind="test.pnl"></span>
        期望值 <span class="font-price text-2xl" ng-bind="test.expectation"></span>
        <span ng-if="test.expectation > 1"> 👍</span>
      </div>
      <div>
        二日有效率 <span class="font-pct text-2xl" ng-bind="test.breakoutRate | pct"></span>
        總勝率 <span class="font-pct text-2xl" ng-bind="test.winRate | pct"></span>
      </div>
      <div ng-if="test.reentry">
        返場 <span class="text-2xl" ng-bind="test.reentry"></span> 次
        成功 <span class="text-2xl" ng-bind="test.reentryWins"></span> 次
        勝率 <span class="font-2xl font-pct" ng-bind="test.reentryWinRate | pct"></span><br />
        返場損益 <span class="text-2xl font-price" ng-bind="test.reentryProfit"></span>
        占比：<span class="font-pct text-2xl" ng-bind="(test.reentryProfit / test.profit) | pct"></span>
      </div>
      <!--<div>最大回撤 <span ng-bind="test.maxDrawdown"></span></div>-->
    </div>
    <div id="trade{{$index}}">
      <div class="bg-white pl-5 pr-5 grid grid-cols-[auto_350px] hover:bg-base-200" ng-repeat="trade in test.trades"
        style="cursor:pointer" ng-click="jump(trade)">
        <ul class="timeline timeline-vertical">
          <li>
            <div class="timeline-start text-base-content/50" ng-bind="trade.entryDate | dt"></div>
            <div class="timeline-middle">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 3.75H6.912a2.25 2.25 0 0 0-2.15 1.588L2.35 13.177a2.25 2.25 0 0 0-.1.661V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 0 0-2.15-1.588H15M2.25 13.5h3.86a2.25 2.25 0 0 1 2.012 1.244l.256.512a2.25 2.25 0 0 0 2.013 1.244h3.218a2.25 2.25 0 0 0 2.013-1.244l.256-.512a2.25 2.25 0 0 1 2.013-1.244h3.859M12 3v8.25m0 0-3-3m3 3 3-3" />
              </svg>
            </div>
            <div class="timeline-end flex">
              <span class="font-price text-xl timeline-box mr-1.5 h-fit" ng-bind="trade.entryPrice.scale(2)"></span>
              <span>
                <span class="badge badge-secondary" ng-if="trade.breakout">二日法則</span>
                <span class="badge badge-secondary" ng-if="trade.reentry">重新入場</span>
                <span class="text-sm/6 text-success" ng-bind="trade.entryReason"></span>
              </span>
            </div>
            <hr class="pt-11" />
          </li>
          <li ng-if="trade.exitPrice">
            <hr />
            <div class="timeline-start text-base-content/50" ng-bind="trade.exitDate | dt"></div>
            <div class="timeline-middle">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
              </svg>
            </div>
            <div class="timeline-end">
              <span class="font-price text-xl timeline-box mr-1.5 h-fit" ng-bind="trade.exitPrice.scale(2)"></span>
              <span>
                <span class="badge badge-primary" ng-if="trade.exitReason.includes('過熱')">過熱</span>
                <span class="text-sm/6 text-success" ng-bind="trade.exitReason"></span>
              </span>
            </div>
            <hr />
          </li>
          <li ng-if="trade.duration">
            <hr class="pt-11" />
            <div class="after:content-['days'] after:text-xs badge badge-ghost timeline-start" ng-bind="trade.duration">
            </div>
          </li>
        </ul>
        <div ng-if="trade.duration" class="border-l-2 border-primary">
          <div class="flex mt-8 items-end">
            <div
              class="w-0 h-0  border-t-[15px] border-t-transparent border-b-[15px] border-b-transparent border-l-[10px] border-l-primary">
            </div>
            🧧 <span class="font-price text-4xl" ng-bind="trade.profit"
              ng-class="{'text-rich-green': trade.profit < 0, 'text-rich-red': trade.profit > 0}"></span>
            <span class="font-pct" ng-bind="trade.profitRate | pct"></span>
          </div>
          <div ng-if="trade.invest">
            <br />
            <div>【分批進出操作模擬】</div>
             <br />
            <div ng-if="log.act" ng-repeat="log in trade.invest.logs">
              <span class="font-date" ng-bind="log.day.date.toLocaleDateString()"></span>
              <span class="font-price" ng-bind="log.day.close.scale(2)"></span>
              <span ng-bind="log.act"></span>：<span class="" ng-bind="log.amount"></span>
              持倉：<span class="" ng-bind="log.invested"></span><br />
              成本：<span class="font-price" ng-bind="log.avgCost"></span>
              停損價：<span class="font-price" ng-bind="(log.stopLossPrice || 0).scale(2)"></span>
              <span class="block" ng-if="log.profit != 0">
                <span ng-if="log.invested == 0">累計</span>損益
                <span class="font-price text-2xl" ng-bind="log.profit"></span>（<span class="font-pct"
                  ng-bind="log.profitRate"></span>）
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>

<div id="invest-form" style="display: none">
  <br />
  <div>
    <span ng-bind="invest.log.act"></span>
    <input type="date" style="border: 1px solid #ccc;" ng-model="invest.log.date">
    <input type="number" style="width: 60px; border: 1px solid #ccc;" ng-model="invest.log.price"> 元
    <input type="number" style="width: 60px; border: 1px solid #ccc;" ng-model="invest.log.amount"> 股
    <input type="checkbox" ng-model="invest.log.shadow" class="checkbox" />大師
  </div>
  <br />
  <div>
    <textarea style="border: 1px solid #ccc;" rows="4" cols="50" ng-model="note.log.note"></textarea>
  </div>
  <div>
    <p>
      <button ng-click="invest.save()">確認</button>
      <button ng-if="invest.log.id" ng-click="invest.destroy()">刪除</button>
    </p>
  </div>
</div>

<div id="dividend-form" style="display: none">
  <br />
  <div>
    <span>收款紀錄</span>
    <input type="date" ng-model="dividend.trade.date">
    <input type="number" ng-model="dividend.trade.price"> 元
    <input type="number" ng-model="dividend.trade.amount"> 股
  </div>
  <div>
    <p>
      <button ng-click="dividend.save()">確認</button>
      <button ng-if="dividend.trade.id" ng-click="dividend.destroy()">刪除</button>
    </p>
  </div>
</div>

<div id="stock-check-list" style="display: none">
  <div class="checklist">
    <div class="caption">
      <span ng-bind="blankList.title"></span>
    </div>
    <div class="header-row">
      <div class="header-cell">多方檢查</div>
      <div class="header-cell">空方檢查</div>
    </div>
    <div class="content-row">
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.long.required">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.short.required">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
    </div>
    <div class="content-row">
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.long.optional">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
      <div class="cell">
        <div class="section">
          <div class="item" ng-repeat="rule in blankList.short.optional">
            <input type="checkbox" ng-checked="rule.checked" ng-model="rule.checked" />
            <span ng-bind="rule.title"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="rich-stock-chart">
  <label ng-repeat="axis in chartAxis.all">
    <input type="checkbox" ng-model="axis.visible" ng-change="chartAxis.toggle(axis)">
    <a target="_blank" ng-href="{{ axis.url }}"><span ng-bind="axis.id"></span></a>
  </label>
</div>
<div id="stock-chart" style="height: 800px; min-width: 800px"></div>